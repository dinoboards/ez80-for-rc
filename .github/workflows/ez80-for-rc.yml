name: ez80-for-rc

on:
  push:
    branches:
      - '**'
    tags-ignore:
      - '**'

jobs:
  ez80-for-rc:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: pull docker tool chain
        run: docker pull dinoboards/ez80-rc-builder && docker pull z88dk/z88dk

      - name: firmware make-debug
        env:
          DISPLAY: :1
        run: docker run --rm -v .:/ez80-for-rc/ --privileged=true -t dinoboards/ez80-rc-builder wine cmd.exe /c "cd firmware & make-debug.bat"

      - name: firmware make-alt-debug
        run: docker run --rm -v .:/ez80-for-rc/ --privileged=true -t dinoboards/ez80-rc-builder wine cmd.exe /c "cd firmware & make-alt-debug.bat"

      - name: firmware make-release
        run: docker run --rm -v .:/ez80-for-rc/ --privileged=true -t dinoboards/ez80-rc-builder wine cmd.exe /c "cd firmware & make-release.bat"

      - name: firmware make-alt-release
        run: docker run --rm -v .:/ez80-for-rc/ --privileged=true -t dinoboards/ez80-rc-builder wine cmd.exe /c "cd firmware & make-alt-release.bat"

      - name: Archive firmware
        uses: actions/upload-artifact@v4
        with:
          compression-level: 0
          name: firmware
          path: |
            firmware/bin

      - name: build apps
        run: docker run -v ./apps:/src/ -t z88dk/z88dk make apps -j RELEASE=true

      - name: Archive apps
        uses: actions/upload-artifact@v4
        with:
          compression-level: 0
          name: apps
          path: |
            apps/bin/release/*.COM

