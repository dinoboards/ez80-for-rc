
	SECTION CODE

	.assume adl=1

MPGSEL_0	EQU	%FF78		; Z2 MEM MGR BANK 0 PAGE SELECT REG (WRITE ONLY)
MPGSEL_1	EQU	%FF79		; Z2 MEM MGR BANK 1 PAGE SELECT REG (WRITE ONLY)
MPGSEL_2	EQU	%FF7A		; Z2 MEM MGR BANK 2 PAGE SELECT REG (WRITE ONLY)
MPGSEL_3	EQU	%FF7B		; Z2 MEM MGR BANK 3 PAGE SELECT REG (WRITE ONLY)
MPGENA		EQU	%FF7C		; Z2 MEM MGR PAGING ENABLE REGISTER (BIT 0, WRITE ONLY)

	PUBLIC	bank_init_z2
bank_init_z2:
	LD.SIS	BC, MPGSEL_0
	XOR	A
	OUT	(BC),A

	INC	A
	INC	BC			; MPGSEL_1
	OUT	(BC),A

	LD	A, 64-2
	INC	BC			; MPGSEL_2
	OUT	(BC),A

	LD	A, 64-1
	INC	BC			; MPGSEL_3
	OUT	(BC),A

	INC	BC			; MPGENA
	LD	A, 1			; ENABLE PAGING
	OUT	(BC),A
	RET

; TRAP HANDLER FOR RST %18 - BANK SWITCHING SUPPORT
; FOR ROMWBW (MM_Z2)
;
; A IS NEW DESIRED BANK TO BE SWITCHED TO
; MUST NOT MODIFY ANY REGISTERS OTHER THAN A
; INTERRUPT MAY HAPPEN DURING BANKING
; FOR MOMENT, ASSUMES AND ONLY SUPPORTS MEMMGR OF MM_Z2
	PUBLIC	_rst_rc2014_bank_switch

_rst_rc2014_bank_switch:
	PUSH	BC
	LD	BC, MPGSEL_0
	BIT	7, A				; BIT 7 SET REQUESTS RAM PAGE
	JR	Z, HBX_ROM			; NOT SET, SELECT ROM PAGE
	RES	7, A				; RAM PAGE REQUESTED: CLEAR ROM BIT
	ADD	A, 16				; ADD 16 x 32K - RAM STARTS FROM 512K

HBX_ROM:
	RLCA					; TIMES 2 - GET 16K PAGE INSTEAD OF 32K
	OUT	(BC), A				; BANK_0: 0K - 16K
	INC	A
	INC	BC				; ASSUME MPGSEL_0 + 1 = MPGSEL_1
	OUT	(BC), A				; BANK_1: 16K - 32K

	POP	BC
	RET.L
